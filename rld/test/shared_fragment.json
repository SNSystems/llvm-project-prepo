// This test contains definitions in two compilations that refer to the same
// fragment.

// RUN: rm -rf %t && mkdir -p %t
// RUN: pstore-import %t/db.db %s
// RUN: repo-create-ticket --repo %t/db.db -o %t/t0.o 072e60601c5545ca9e6d759ab9d7484f
// RUN: repo-create-ticket --repo %t/db.db -o %t/t1.o cdbabbba384d4f12a6c6656eada97d72
// RUN: rld --repo=%t/db.db -o %t/rld.out %t/t0.o %t/t1.o
// RUN: llvm-readelf --hex-dump=.rodata %t/rld.out | FileCheck %s

// CHECK: Hex dump of section '.rodata':
// CHECK-NEXT: 0x004000e8 f0004000 f0004000 52454144 f0004000

{
  "version": 1,
  "id"     : "36ba223b-4eec-4d57-bd86-3650c68e722b",
  "transactions": [
    {
      "names": [
        "x86_64-pc-linux-gnu-repo", // 0
        "f", // 1
        "g", // 2
        "h", // 3
        "j"  // 4
      ],

      "fragments": {
        // Used for definition h.
        "75dc28989269433bb972a59f17403dab": {
          "read_only": { "data": "UkVBRA==" } // payload is "READ" (0x52, 0x45, 0x41, 0x44).
        },

        // Used for definitions f, g, and j.
        "8cda64e4d658472f885f58d331025fbd": {
          "read_only": {
            "data" : "ZGF0YQ==", // payload is "data" (0x64, 0x61, 0x74, 0x61).
            "xfixups": [
              { "name": 3, "type": 1, "offset": 0, "addend": 0 } // "h"
            ]
          }
        }
      }, // fragments

      "compilations": {
        // This compilation has two definitions that reference the same fragment (8cda).
        "072e60601c5545ca9e6d759ab9d7484f": {
          "triple": 0, // "x86_64-pc-linux-gnu-repo"
          "definitions": [
            { "digest": "8cda64e4d658472f885f58d331025fbd", "name": 1, "linkage": "external" }, // "f"
            { "digest": "8cda64e4d658472f885f58d331025fbd", "name": 2, "linkage": "external" }, // "g"
            { "digest": "75dc28989269433bb972a59f17403dab", "name": 3, "linkage": "external" }  // "h"
          ]
        },

        // A compilation which contains a third reference to that fragment (8cda).
        "cdbabbba384d4f12a6c6656eada97d72": {
          "triple": 0, // "x86_64-pc-linux-gnu-repo"
          "definitions": [
            { "digest": "8cda64e4d658472f885f58d331025fbd", "name": 4, "linkage": "external" } // "j"
          ]
        }
      } // compilations
    } // transaction #1
  ] // transactions
}

