// RUN: rm -rf %t && mkdir -p %t
// RUN: pstore-import %t/db.db %s
// RUN: repo-create-ticket --repo %t/db.db -o %t/t0.o 008fecf0ccab0c7a71a5672579eaca1e
// RUN: repo-create-ticket --repo %t/db.db -o %t/t1.o 6c951506a8c75884774cd5d4507740cd
// RUN: rld --repo=%t/db.db -o %t/rld.out %t/t0.o %t/t1.o
// RUN: llvm-readelf --section-headers %t/rld.out | FileCheck %s

// Note that this check is rather fragile ATM. The .rodata.str1.1 section should NOT
// be in the output (it should be merged into .rodata).

// CHECK: There are 7 section headers
// CHECK: [Nr] Name           Type     Address          Off    Size   ES Flg Lk Inf Al
// CHECK: [ 0]                NULL     0000000000000000 000000 000000 00      0   0  0
// CHECK: [ 1] .text          PROGBITS 0000000000401000 001000 0000c6 00  AX  0   0 16
// CHECK: [ 2] .rodata.str1.1 PROGBITS 0000000000400120 000120 000013 01  AM  0   0  1
// CHECK: [ 3] .rodata        PROGBITS 0000000000400138 000138 000020 00   A  0   0  8
// CHECK: [ 4] .shstrtab      STRTAB   0000000000000000 002000 000038 00      0   0  1
// CHECK: [ 5] .strtab        STRTAB   0000000000000000 002038 000026 00      0   0  1
// CHECK: [ 6] .symtab        SYMTAB   0000000000000000 00205e 000090 18      5   3  1


{
    "version":1,
    "id":"5c48fe38-dfef-4d89-97c8-cfee853f4fd3",
    "transactions":[
        {
            // generation 1
            "names":[
                "x86_64-pc-linux-gnu-repo", // 0
                "main", // 1
                "printf", // 2
                ".str.1", // 3
                ".str", // 4
                "ultimate_answer", // 5
                "foo" // 6
            ],
            "fragments":{
                "f9bb578a7abfc702dc7fa54f7b4af05f":{
                    "text":{
                        "align":16,
                        "data":"VUiJ5bgrAAAAXcM="
                    }
                },
                "1ce0ffb3c3f3440bbdcfd26e4d66dc24":{
                    "mergeable_1_byte_c_string":{
                        "data":"JWQKAA=="
                    }
                },
                "96ded9543181a34d8d1427698348ad1d":{
                    "text":{
                        "align":16,
                        "data":"VUiJ5UiD7BBIvwAAAAAAAAAAsADoAAAAAL8GAAAAiUX86AAAAABIvwAAAAAAAAAAicawAOgAAAAAMcmJRfiJyEiDxBBdww=="
                    }
                },
                "d86ded26b9f6811fe38f8a5812db1dc9":{
                    "mergeable_1_byte_c_string":{
                        "data":"SGVsbG8sIHdvcmxkLgoA"
                    }
                }
            },
            "compilations":{
                "008fecf0ccab0c7a71a5672579eaca1e":{
                    "triple":0, //"x86_64-pc-linux-gnu-repo"
                    "definitions":[
                        {"digest":"f9bb578a7abfc702dc7fa54f7b4af05f","name":5,"linkage":"external"}, //"ultimate_answer"
                        {"digest":"96ded9543181a34d8d1427698348ad1d","name":1,"linkage":"external"}, //"main"
                        {"digest":"d86ded26b9f6811fe38f8a5812db1dc9","name":4,"linkage":"internal_no_symbol"}, //".str"
                        {"digest":"1ce0ffb3c3f3440bbdcfd26e4d66dc24","name":3,"linkage":"internal_no_symbol"} //".str.1"
                    ]
                }
            }
        },
        {
            // generation 2
            "fragments":{
                "024badfa2effcb85e10be56851688097":{
                    "text":{
                        "align":16,
                        "data":"VUiJ5Yl9+ItF+IPA/4nBg+gDSIlN8A+HPgAAAEiLRfBIiwzFAAAAAP/hx0X8BQAAAOkrAAAAx0X8BgAAAOkfAAAAx0X8BwAAAOkTAAAAx0X8CAAAAOkHAAAAx0X8CQAAAItF/F3D",
                        "ifixups":[
                            {"section":"read_only","type":11,"offset":36,"addend":0}
                        ]
                    },
                    "read_only":{
                        "align":8,
                        "data":"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=",
                        "ifixups":[
                            {"section":"text","type":1,"offset":0,"addend":42},
                            {"section":"text","type":1,"offset":8,"addend":54},
                            {"section":"text","type":1,"offset":16,"addend":66},
                            {"section":"text","type":1,"offset":24,"addend":78}
                        ]
                    }
                }
            },
            "compilations":{
                "6c951506a8c75884774cd5d4507740cd":{
                    "triple":0, //"x86_64-pc-linux-gnu-repo"
                    "definitions":[
                        {"digest":"024badfa2effcb85e10be56851688097","name":6,"linkage":"external"} //"foo"
                    ]
                }
            }
        }
    ]
}
